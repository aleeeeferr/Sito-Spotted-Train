<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Biglietto acquistato</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="../css/style.css">
<script src="../js/nav-links.js" defer></script>
  <style>
    body.success-page {
      background: radial-gradient(circle at 12% 18%, rgba(14, 165, 233, 0.2), transparent 32%),
        radial-gradient(circle at 85% 30%, rgba(245, 158, 11, 0.16), transparent 34%),
        radial-gradient(circle at 30% 80%, rgba(14, 165, 233, 0.12), transparent 28%),
        linear-gradient(135deg, #050910, #0a162c 48%, #0c1c38);
      min-height: 100vh;
      color: #e2e8f0;
    }

    .success-hero {
      background: linear-gradient(120deg, rgba(14, 165, 233, 0.25), rgba(11, 19, 39, 0.85));
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 22px;
      padding: 22px 26px;
      box-shadow: 0 22px 80px -40px rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(6px);
      color: #cbd5e1;
    }

    .success-hero h1 {
      color: #f8fafc;
      letter-spacing: -0.02em;
    }

    .ticket-success-card {
      position: relative;
      overflow: hidden;
      border-radius: 20px;
      background: radial-gradient(circle at 75% 20%, rgba(14, 165, 233, 0.08), transparent 40%),
        radial-gradient(circle at 15% 15%, rgba(245, 158, 11, 0.16), transparent 36%),
        linear-gradient(145deg, #eef5ff, #f8fbff);
      box-shadow: 0 28px 80px -38px rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(226, 232, 240, 0.8);
      padding: 26px;
      color: #0f172a;
    }

    .ticket-success-banner {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 12px;
      background: #16a34a;
      color: #fff;
      font-weight: 700;
      font-size: 0.95rem;
      box-shadow: 0 10px 30px -12px rgba(22, 163, 74, 0.65);
      position: relative;
      z-index: 1;
    }

    .ticket-success-body {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap: 24px;
      align-items: center;
    }

    .ticket-eyebrow {
      font-size: 0.72rem;
      letter-spacing: 0.18em;
      font-weight: 800;
      color: #94a3b8;
      margin-bottom: 4px;
    }

    .ticket-success-text h2 {
      letter-spacing: -0.02em;
    }

    .ticket-success-text .lead {
      letter-spacing: 0.02em;
      font-weight: 700;
    }

    .ticket-meta {
      color: #475569;
      font-weight: 700;
      margin-bottom: 0;
    }

    .ticket-success-qr {
      text-align: center;
      background: #fff;
      border: 1px dashed #d1d5db;
      border-radius: 18px;
      padding: 18px 16px;
      min-width: 280px;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .qr-frame {
      background: #fff;
      border: 1px solid #e0e5ec;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 10px 32px rgba(0, 0, 0, 0.12);
    }

    .qr-frame img {
      width: 240px;
      height: 240px;
      object-fit: contain;
    }

    .ticket-success-footer {
      position: relative;
      z-index: 1;
      border-top: 1px dashed #e5e7eb;
      margin-top: 18px;
      padding-top: 14px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      justify-content: space-between;
      color: #0f172a;
    }

    .ticket-success-footer strong {
      display: block;
      font-size: 1.05rem;
      letter-spacing: -0.01em;
    }

    .success-actions .btn {
      min-width: 170px;
    }

    @media (max-width: 992px) {
      .ticket-success-body {
        grid-template-columns: 1fr;
      }
      .ticket-success-qr {
        min-width: auto;
      }
    }
  </style>
</head>
<body class="app-body success-page">
  <nav class="topbar">
    <div class="container d-flex align-items-center justify-content-between gap-3">
      <a class="brand" href="/index.html"><span class="dot"></span>EAV Treni</a>
      <div class="nav-links d-none d-md-flex">
        <a href="/index.html">Ricerca orari</a>
        <a href="/pages/tracking.html">Tracking live</a>
        <a href="/pages/mappa.html">Mappa linee</a>
        <a class="active" href="/pages/acquista.html">Biglietti</a>
        <a href="/pages/avvisi.html">Avvisi</a>
      </div>
      <div class="nav-actions d-flex align-items-center gap-2">
        <span class="pill pill-soft">Dati live</span>
        <a class="btn btn-sm btn-outline-light" href="/pages/utente.html">Area utente</a>
      </div>
    </div>
  </nav>

  <main class="container page-shell py-4 py-md-5">
    <section class="success-hero mb-4 d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <p class="eyebrow mb-1">Ticketing demo</p>
        <h1 class="h4 mb-1">Biglietto acquistato con successo</h1>
        <p class="muted mb-0">Pagina statica: mostra un QR stile Unicampania senza azioni aggiuntive.</p>
      </div>
      <span class="pill pill-ghost">Demo</span>
    </section>

    <section class="metrics-grid mb-3">
      <div class="metric-card">
        <small>Pagamento</small>
        <strong>Completato</strong>
        <span class="small d-block">Solo dimostrativo, dati locali</span>
      </div>
      <div class="metric-card">
        <small>QR</small>
        <strong>Generato</strong>
        <span class="small d-block">In stile UnicoCampania</span>
      </div>
    </section>

    <section class="row g-3 align-items-stretch justify-content-center">
      <div class="col-lg-8 col-xl-7">
        <div class="ticket-success-card surface-card">
          <div class="ticket-success-banner">Pagamento completato</div>
          <div class="ticket-success-body mt-3">
            <div class="ticket-success-text">
              <p class="ticket-eyebrow">TITOLO DIGITALE</p>
              <h2 class="h4 mb-1" id="ticketLabel">Biglietto demo</h2>
              <p class="lead mb-2" id="ticketSummary">Tratta demo</p>
              <p class="ticket-meta mb-0" id="ticketMeta">Codice tariffa DEMO · DEMO · € 0,00</p>
            </div>
            <div class="ticket-success-qr">
              <div class="qr-frame">
                <img id="ticketQr" src="" alt="QR del biglietto" width="240" height="240">
              </div>
              <p class="small muted mb-0 mt-2">Mostra il codice al controllo</p>
            </div>
          </div>
          <div class="ticket-success-footer">
            <div>
              <p class="small mb-1 muted">Validità</p>
              <strong id="ticketValidity">Solo dimostrativo - Unicampania</strong>
            </div>
            <div>
              <p class="small mb-1 muted">Emesso</p>
              <strong id="ticketTimestamp">Ora locale</strong>
            </div>
          </div>
          <div class="success-actions d-flex justify-content-center gap-2 mt-3 position-relative" style="z-index:1;">
            <a class="btn btn-primary px-4" href="/pages/acquista.html">Acquista un altro</a>
            <a class="btn btn-outline-secondary px-4" href="/index.html">Torna alla home</a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    (function () {
      const fallback = {
        label: "Biglietto demo",
        variant: "DEMO",
        price: 0,
        priceFormatted: "0,00",
        tariff: "DEMO",
        origine: "Tratta",
        destinazione: "Demo",
        timestamp: new Date().toISOString(),
      };

      let ticket = { ...fallback };

      try {
        const raw = sessionStorage.getItem("spotted-last-ticket");
        if (raw) {
          const parsed = JSON.parse(raw);
          ticket = { ...ticket, ...parsed };
        }
      } catch (error) {
        console.warn("Ticket demo non disponibile, uso fallback", error);
      }

      const route =
        ticket.origine && ticket.destinazione
          ? `${ticket.origine.toUpperCase()} → ${ticket.destinazione.toUpperCase()}`
          : "Tratta demo";
      const priceText = ticket.priceFormatted ? `€ ${ticket.priceFormatted}` : formatEuro(ticket.price);
      const variant = ticket.variant ? ticket.variant.toUpperCase() : fallback.variant;
      const tariff = ticket.tariff || fallback.tariff;

      document.getElementById("ticketLabel").textContent = ticket.label || fallback.label;
      document.getElementById("ticketSummary").textContent = route;
      document.getElementById("ticketMeta").textContent = `Codice ${tariff} · ${variant} · ${priceText}`;
      document.getElementById("ticketValidity").textContent = `Codice tariffa ${tariff} · Solo simulazione`;
      document.getElementById("ticketTimestamp").textContent = formatDateTime(ticket.timestamp);
      document.getElementById("ticketQr").src = buildPseudoQr(ticket);
    })();

    function formatEuro(value) {
      const num = Number(value);
      if (!Number.isFinite(num)) return "€ 0,00";
      return `€ ${num.toLocaleString("it-IT", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    function formatDateTime(value) {
      try {
        const date = value ? new Date(value) : new Date();
        return new Intl.DateTimeFormat("it-IT", { dateStyle: "medium", timeStyle: "short" }).format(date);
      } catch (error) {
        return "Ora locale";
      }
    }

    function buildPseudoQr(ticket) {
      const text = `${ticket.label || "ticket"}|${ticket.variant || "demo"}|${ticket.tariff || "demo"}|${ticket.origine || ""}-${ticket.destinazione || ""}`;
      let seed = 0;
      for (let i = 0; i < text.length; i += 1) {
        seed = (seed + text.charCodeAt(i) * (i + 1)) % 2147483647;
      }

      const size = 25;
      const modules = new Set();
      const finderOffsets = [
        [0, 0],
        [size - 7, 0],
        [0, size - 7],
      ];

      finderOffsets.forEach(([ox, oy]) => addFinderPattern(modules, ox, oy));

      for (let y = 0; y < size; y += 1) {
        for (let x = 0; x < size; x += 1) {
          const key = `${x},${y}`;
          if (modules.has(key) || isInsideFinder(x, y, size)) continue;
          if (randomBit()) {
            modules.add(key);
          }
        }
      }

      const rects = Array.from(modules)
        .map((key) => {
          const [x, y] = key.split(",").map(Number);
          return `<rect x="${x}" y="${y}" width="1" height="1" />`;
        })
        .join("");

      const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${size} ${size}' shape-rendering='crispEdges'><rect width='${size}' height='${size}' fill='white'/><g fill='black'>${rects}</g></svg>`;
      return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;

      function randomBit() {
        seed = (seed * 1664525 + 1013904223) % 4294967296;
        return seed % 2 === 0;
      }
    }

    function addFinderPattern(modules, offsetX, offsetY) {
      for (let y = 0; y < 7; y += 1) {
        for (let x = 0; x < 7; x += 1) {
          const isBorder = x === 0 || y === 0 || x === 6 || y === 6;
          const isCenter = x >= 2 && x <= 4 && y >= 2 && y <= 4;
          if (isBorder || isCenter) {
            modules.add(`${offsetX + x},${offsetY + y}`);
          }
        }
      }
    }

    function isInsideFinder(x, y, size) {
      const zones = [
        [0, 7, 0, 7],
        [size - 7, size, 0, 7],
        [0, 7, size - 7, size],
      ];
      return zones.some(([x0, x1, y0, y1]) => x >= x0 && x < x1 && y >= y0 && y < y1);
    }
  </script>
</body>
</html>
