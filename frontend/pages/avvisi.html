<!doctype html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Avvisi EAV</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../css/static.css" />
  <link rel="stylesheet" href="../css/style.css" />
  <script src="../js/nav-links.js" defer></script>
</head>
<body class="app-body">
  <nav class="topbar">
    <div class="container d-flex align-items-center justify-content-between gap-3">
      <a class="brand" href="/index.html"><span class="dot"></span>EAV Treni</a>
      <div class="nav-links d-none d-md-flex">
        <a href="/index.html">Ricerca orari</a>
        <a href="/pages/tracking.html">Tracking live</a>
        <a href="/pages/mappa.html">Mappa linee</a>
        <a href="/pages/acquista.html">Biglietti</a>
        <a class="active" href="/pages/avvisi.html">Avvisi</a>
      </div>
      <div class="nav-actions d-flex align-items-center gap-2">
        <span class="pill pill-soft">Dati live</span>
        <a class="btn btn-sm btn-outline-light" href="/pages/utente.html">Area utente</a>
      </div>
    </div>
  </nav>

  <main class="container page-shell py-4 py-md-5 static-container">
    <section class="page-hero-card mb-4 d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <p class="eyebrow mb-1">Avvisi</p>
        <h1 class="h4 mb-1">Comunicazioni di rete</h1>
        <p class="muted mb-0">Ritardi, soppressioni, scioperi e note in una veste coerente col resto del sito.</p>
        <div class="d-flex align-items-center gap-2 flex-wrap mt-2">
          <span class="pill-contrast is-ghost">Dati Firestore</span>
          <span class="pill-contrast is-ghost">Ordinati per tema</span>
          <span class="pill-contrast is-ghost">Espandi per i dettagli</span>
        </div>
        <div class="list-soft mt-2">
          <div class="item">
            <span class="meta-chip text-muted">Documento</span>
            <span class="small text-muted">avvisi/latest come fonte principale, fallback alla collezione.</span>
          </div>
          <div class="item">
            <span class="meta-chip text-muted">Grouping</span>
            <span class="small text-muted">Ritardi, Soppressioni, Scioperi e Avvisi generici.</span>
          </div>
        </div>
      </div>
      <div class="hero-kpis">
        <div class="hero-kpi">
          <small>Fonte</small>
          <strong>Firestore</strong>
          <div class="muted small">Documento avvisi/latest</div>
        </div>
        <div class="hero-kpi">
          <small>Dettagli</small>
          <strong>Espandibili</strong>
          <div class="muted small">Summary + testo completo</div>
        </div>
      </div>
    </section>

    <section class="static-card">
      <div class="tariff-toolbar mb-2">
        <div>
          <p class="eyebrow mb-1">Rete EAV</p>
          <h3 class="h5 mb-0">Situazione aggiornata</h3>
        </div>
        <div class="tariff-meta">
          <span class="pill pill-soft">Live</span>
          <span class="pill pill-soft">Raggruppo automatico</span>
        </div>
      </div>
      <p class="tariff-note mb-3">Gli avvisi vengono suddivisi in Ritardi, Soppressioni, Scioperi o Avvisi generici. Clicca su ogni scheda per leggere tutti i dettagli.</p>
      <div id="alerts-container" class="alerts-container">
        <div class="tariffe-static-card">Caricamento avvisi...</div>
      </div>
    </section>
  </main>

  <script type="module">
    import { fetchAlerts } from "../js/firebaseApi.js";

    async function loadAlerts() {
      const container = document.getElementById("alerts-container");
      if (!container) return;
      try {
        const result = await fetchAlerts();
        const valid = (result.items || []).filter((a) => Boolean(a?.descrizione || a?.description));
        if (!valid.length) {
          container.innerHTML = '<div class="tariffe-static-card">Nessun avviso disponibile.</div>';
          return;
        }
        const buckets = groupAlerts(valid);
        container.innerHTML = buckets
          .map(
            ({ label, items }) => `
              <section class="alert-section">
                <h3 class="alert-section-title">${label}</h3>
                <div class="alert-section-list">
                  ${items
                    .map((alert) => {
                      const title = alert.titolo || alert.title || "Avviso";
                      const desc = alert.descrizione || alert.description || "";
                      const date = alert.data || alert.date || "";
                      const line = alert.linea || alert.line || "";
                      return `
                        <details class="alert-card ${deriveClass(label)}">
                          <summary>
                            <div class="alert-header">
                              <h3 class="alert-title">${title}</h3>
                              <span class="alert-type">${line || "Info"}</span>
                            </div>
                            <p class="alert-snippet">${desc}</p>
                            <div class="alert-footer">
                              <span class="alert-date">${date}</span>
                            </div>
                          </summary>
                          <div class="alert-full">
                            <p>${desc}</p>
                          </div>
                        </details>
                      `;
                    })
                    .join("")}
                </div>
              </section>
            `
          )
          .join("");
      } catch (err) {
        container.innerHTML = '<div class="tariffe-static-card">Errore nel caricare gli avvisi.</div>';
      }
    }

    function groupAlerts(list) {
      const buckets = { Ritardi: [], Soppressioni: [], Scioperi: [], Avvisi: [] };
      list.forEach((alert) => {
        const text = `${alert.titolo || ""} ${alert.descrizione || alert.description || ""}`.toLowerCase();
        if (text.includes("soppres")) buckets.Soppressioni.push(alert);
        else if (text.includes("scioper")) buckets.Scioperi.push(alert);
        else if (text.includes("ritard")) buckets.Ritardi.push(alert);
        else buckets.Avvisi.push(alert);
      });
      return Object.entries(buckets)
        .map(([label, items]) => ({ label, items }))
        .filter((b) => b.items.length);
    }

    function deriveClass(label) {
      if (label === "Scioperi") return "sciopero";
      if (label === "Ritardi") return "ritardo";
      if (label === "Soppressioni") return "sciopero";
      return "";
    }

    loadAlerts();
  </script>
</body>
</html>
